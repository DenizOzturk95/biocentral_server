name: Test

on:
  push:
    branches: [ 'main', 'develop', 'feature/tests' ]
  pull_request:
    branches: [ 'main', 'develop', 'feature/tests' ]

jobs:
  unit-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest ]
        python-version: [ '3.12' ]

    steps:
      - name: Free disk space
        run: |
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          df -h

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Configure Git to use HTTPS for git dependencies
        run: |
          git config --global url."https://github.com/".insteadOf git@github.com:

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Run pytest (unit tests)
        uses: coactions/setup-xvfb@v1
        with:
          run: uv run pytest tests/unit/ -v

  integration-test:
    runs-on: ubuntu-latest
    needs: unit-test

    steps:
      - name: Free disk space
        run: |
          echo "Before cleanup:"
          df -h /
          # Remove all non-essential pre-installed tools
          sudo rm -rf \
            /usr/share/dotnet /usr/local/lib/android /opt/ghc \
            /opt/hostedtoolcache/CodeQL /opt/hostedtoolcache/go \
            /opt/hostedtoolcache/node /opt/hostedtoolcache/Ruby \
            /opt/hostedtoolcache/Java* /opt/hostedtoolcache/PyPy \
            /usr/share/swift /usr/local/graalvm /usr/local/.ghcup \
            /usr/local/share/powershell /usr/local/share/vcpkg \
            /usr/local/share/chromium /usr/local/share/boost \
            /opt/microsoft /opt/az /opt/google /opt/pipx \
            /usr/share/az_* /usr/share/miniconda /usr/share/gradle-* \
            /usr/share/apache-maven-* /usr/share/sbt /usr/share/rust \
            /usr/share/kotlinc /usr/share/java /usr/share/ri \
            /home/runner/.cargo /home/runner/.rustup /home/runner/.dotnet \
            /home/runner/.local/share/powershell \
            /usr/local/aws-* /usr/local/julia* /usr/local/sqlpackage \
            /usr/lib/firefox /usr/lib/google-cloud-sdk \
            /usr/lib/jvm /usr/lib/mono /usr/lib/heroku \
            /var/lib/apt/lists/* /var/cache/apt/archives/*
          sudo apt-get clean
          docker system prune -af --volumes
          echo "After cleanup:"
          df -h /

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Configure Git to use HTTPS for git dependencies
        run: |
          git config --global url."https://github.com/".insteadOf git@github.com:

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Start services with Docker Compose
        run: |
          docker compose -f docker-compose.dev.yml --env-file .env.ci up -d --build --wait
        env:
          DOCKER_BUILDKIT: 1
          COMPOSE_DOCKER_CLI_BUILD: 1
          BUILDKIT_STEP_LOG_MAX_SIZE: 10000000
        timeout-minutes: 15

      - name: Wait for server to be healthy
        run: |
          echo "Waiting for biocentral-server to be healthy..."
          for i in {1..30}; do
            if curl -s http://localhost:9540/health > /dev/null 2>&1; then
              echo "Server is healthy!"
              exit 0
            fi
            echo "Attempt $i/30 - Server not ready yet, waiting..."
            sleep 5
          done
          echo "Server failed to become healthy"
          docker compose -f docker-compose.dev.yml logs biocentral-server
          exit 1
        timeout-minutes: 5

      - name: Run integration tests
        uses: coactions/setup-xvfb@v1
        env:
          CI_SERVER_URL: http://localhost:9540
        with:
          run: uv run pytest tests/integration/ -v -m "not triton"

      - name: Show logs on failure
        if: failure()
        run: |
          docker compose -f docker-compose.dev.yml logs

      - name: Stop services
        if: always()
        run: |
          docker compose -f docker-compose.dev.yml down -v

