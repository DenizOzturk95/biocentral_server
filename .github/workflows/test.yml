name: Test

on:
  push:
    branches: [ 'main', 'develop', 'feature/tests' ]
  pull_request:
    branches: [ 'main', 'develop', 'feature/tests' ]

jobs:
  unit-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest ]
        python-version: [ '3.12' ]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Configure Git to use HTTPS for git dependencies
        run: |
          git config --global url."https://github.com/".insteadOf git@github.com:

      - name: Install Linux Dependencies
        run: |
          sudo apt-get update
          curl -LsSf https://astral.sh/uv/install.sh | sh
          source $HOME/.cargo/env
          uv sync

      - name: Run pytest (unit tests)
        uses: coactions/setup-xvfb@v1
        with:
          run: uv run pytest tests/unit/ -v

      - name: Run mutation testing (utils module)
        uses: coactions/setup-xvfb@v1
        with:
          run: |
            uv run mutmut run --paths-to-mutate biocentral_server/utils/ --runner "python -m pytest tests/unit/ -x -q --tb=no" --CI --config tests/setup.cfg
            uv run python tests/scripts/mutation_score.py

  integration-test:
    runs-on: ubuntu-latest
    needs: unit-test

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Configure Git to use HTTPS for git dependencies
        run: |
          git config --global url."https://github.com/".insteadOf git@github.com:

      - name: Install uv and dependencies
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          source $HOME/.cargo/env
          uv sync

      - name: Start services with Docker Compose
        run: |
          docker compose -f docker-compose.dev.yml --env-file .env.ci up -d --build --wait
        timeout-minutes: 10

      - name: Wait for server to be healthy
        run: |
          echo "Waiting for biocentral-server to be healthy..."
          for i in {1..30}; do
            if curl -s http://localhost:9540/health > /dev/null 2>&1; then
              echo "Server is healthy!"
              exit 0
            fi
            echo "Attempt $i/30 - Server not ready yet, waiting..."
            sleep 5
          done
          echo "Server failed to become healthy"
          docker compose -f docker-compose.dev.yml logs biocentral-server
          exit 1
        timeout-minutes: 5

      - name: Run integration tests
        uses: coactions/setup-xvfb@v1
        env:
          CI_SERVER_URL: http://localhost:9540
        with:
          run: uv run pytest tests/integration/ -v -m "not triton"

      - name: Show logs on failure
        if: failure()
        run: |
          docker compose -f docker-compose.dev.yml logs

      - name: Stop services
        if: always()
        run: |
          docker compose -f docker-compose.dev.yml down -v

