name: Test

on:
  push:
    branches: [ 'main', 'develop', 'feature/tests' ]
  pull_request:
    branches: [ 'main', 'develop', 'feature/tests' ]
  workflow_dispatch:
    inputs:
      skip_unit_tests:
        description: 'Skip unit tests'
        required: false
        default: true
        type: boolean

# Required for GHA cache to work on pull requests
permissions:
  contents: read
  actions: write

jobs:
  unit-test:
    if: ${{ github.event.inputs.skip_unit_tests != 'true' }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest ]
        python-version: [ '3.12' ]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Configure Git to use HTTPS for git dependencies
        run: |
          git config --global url."https://github.com/".insteadOf git@github.com:

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "0.9.26"
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Cache venv and uv artifacts
        uses: actions/cache@v4
        id: cache-venv
        with:
          path: |
            .venv
            ~/.cache/uv
          key: venv-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-py${{ matrix.python-version }}-

      - name: Install dependencies
        run: uv sync --frozen

      - name: Run pytest (unit tests)
        run: uv run pytest tests/unit/ -v

  integration-test:
    runs-on: ubuntu-latest
    needs: unit-test
    if: ${{ always() && (needs.unit-test.result == 'success' || needs.unit-test.result == 'skipped') }}

    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/hostedtoolcache
          docker system prune -af --volumes

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Configure Git to use HTTPS for git dependencies
        run: |
          git config --global url."https://github.com/".insteadOf git@github.com:

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "0.9.26"
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      #- name: Cache venv
       # uses: actions/cache@v4
       # id: cache-venv
       # with:
       #   path: |
       #     .venv
       #     ~/.cache/uv
       #   key: venv-${{ runner.os }}-py3.12-${{ hashFiles('uv.lock') }}
       #   restore-keys: |
       #     venv-${{ runner.os }}-py3.12-

      - name: Pin setuptools (legacy)
        run: python -m pip install --upgrade "setuptools==65.5.0"

      - name: Install dependencies
        run: uv sync

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image with cache
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: biocentral-server:ci
          build-args: |
            UV_EXTRA_INDEX_URL=https://download.pytorch.org/whl/cpu
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Start services with Docker Compose
        run: |
          docker compose -f docker-compose.dev.yml --env-file .env.ci up -d --wait
        env:
          DOCKER_BUILDKIT: 1
          COMPOSE_DOCKER_CLI_BUILD: 1
          BUILDKIT_STEP_LOG_MAX_SIZE: 10000000
          CI_IMAGE: biocentral-server:ci
        timeout-minutes: 10

      - name: Wait for server to be healthy
        run: |
          echo "Waiting for biocentral-server to be healthy..."
          for i in {1..30}; do
            if curl -s http://localhost:9540/health > /dev/null 2>&1; then
              echo "Server is healthy!"
              exit 0
            fi
            echo "Attempt $i/30 - Server not ready yet, waiting..."
            sleep 5
          done
          echo "Server failed to become healthy"
          docker compose -f docker-compose.dev.yml logs biocentral-server
          exit 1
        timeout-minutes: 5

      - name: Run integration tests
        run: uv run pytest tests/integration/ -v -m "not triton"
        env:
          CI_SERVER_URL: http://localhost:9540
          # CI_EMBEDDER: fixed # Uncomment and set if specific embedder is needed

      - name: Show logs on failure
        if: failure()
        run: |
          docker compose -f docker-compose.dev.yml logs

      - name: Stop services
        if: always()
        run: |
          docker compose -f docker-compose.dev.yml down -v

