name: Test

on:
  push:
    branches: [ 'main', 'develop', 'feature/tests' ]
  pull_request:
    branches: [ 'main', 'develop', 'feature/tests' ]
  workflow_dispatch:
    inputs:
      skip_unit_tests:
        description: 'Skip unit tests'
        required: false
        default: true
        type: boolean
      reason:
        description: 'Why are you running this?'
        required: false
        default: 'Manual trigger'

# Required for GHA cache to work on pull requests
permissions:
  contents: read
  packages: read
  actions: write

jobs:
  unit-test:
    if: ${{ github.event.inputs.skip_unit_tests != 'true' }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest ]
        python-version: [ '3.12' ]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Configure Git to use HTTPS for git dependencies
        run: |
          git config --global url."https://github.com/".insteadOf git@github.com:

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "0.9.26"
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Cache venv and uv artifacts
        uses: actions/cache@v4
        id: cache-venv
        with:
          path: |
            .venv
            ~/.cache/uv
          key: venv-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-py${{ matrix.python-version }}-

      - name: Install dependencies
        run: uv sync --frozen

      - name: Run pytest (unit tests)
        run: uv run pytest tests/unit/ -v -W "ignore::DeprecationWarning"

  integration-test:
    runs-on: ubuntu-latest
    needs: unit-test
    if: ${{ always() && (needs.unit-test.result == 'success' || needs.unit-test.result == 'skipped') }}

    steps:
      - name: Maximize build disk space
        uses: easimon/maximize-build-space@v10
        with:
          root-reserve-mb: 24576
          swap-size-mb: 1024
          temp-reserve-mb: 16384
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'       
          remove-codeql: 'true'
          remove-docker-images: 'true'
          overprovision-lvm: 'true'

      - name: Move Docker storage to large partition
        run: |
          sudo systemctl stop docker.service
          sudo systemctl stop docker.socket
          sudo mkdir -p /home/runner/work/docker
          sudo mv /var/lib/docker /home/runner/work/docker
          sudo ln -s /home/runner/work/docker /var/lib/docker
          sudo systemctl start docker.service
        
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Configure Git to use HTTPS for git dependencies
        run: |
          git config --global url."https://github.com/".insteadOf git@github.com:

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "0.9.26"
          enable-cache: true
          cache-dependency-glob: "uv.lock"
          cache-local-path: "tmp/.uv-cache"

      - name: Install dependencies
        run: uv sync --no-install-project

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image
        run: docker pull ghcr.io/denizozturk95/biocentral-server:ci

      - name: Start services with Docker Compose
        run: |
          docker compose -f docker-compose.dev.yml --env-file .env.ci up -d --wait
        env:
          DOCKER_BUILDKIT: 1
          COMPOSE_DOCKER_CLI_BUILD: 1
          BUILDKIT_STEP_LOG_MAX_SIZE: 10000000
          CI_IMAGE: ghcr.io/denizozturk95/biocentral-server:ci 
        timeout-minutes: 10

      - name: Run integration tests
        run: uv run pytest tests/integration/ -v -m "not triton"  --reruns 2 --reruns-delay 10 --durations=0 -W "ignore::DeprecationWarning"  --capture=tee-sys
        env:
          CI_SERVER_URL: http://localhost:9540
          #CI_EMBEDDER: fixed  # Uncomment and set if specific embedder is needed

      - name: Show logs 
        if: always()
        run: |
          docker compose -f docker-compose.dev.yml logs

      - name: Stop services
        if: always()
        run: |
          docker compose -f docker-compose.dev.yml down -v

